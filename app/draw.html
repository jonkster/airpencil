<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple Air Drawing</title>

  <script src="../bower_components/tracking/build/tracking.js"></script>

  <style>
    #canvas,
    #video {
        padding-top: 6em;
        position: absolute;
        height: 600px;
        width: 800px;
    }

    #output-frame {
        width:800px;
        height:600px;
        float:right;
        border: 1px solid green;
    }

    canvas, video {
      -moz-transform: scale(-1, 1);
      -o-transform: scale(-1, 1);
      -webkit-transform: scale(-1, 1);
      filter: FlipH;
      transform: scale(-1, 1);
    }
  </style>
</head>
<body>

    <div id="output-frame">
        <canvas id="canvas2"></canvas>
  </div>

  <div id="draw-frame">
      <video id="video"  preload autoplay loop muted></video>
      <canvas id="canvas" width="800" height="600"></canvas>
  </div>
  
  <p>press &lt;Space-Bar&gt; to start drawing</p>
  <p>press 'A' to erase all</p>
  <p>use Arrow keys to scroll</p>

  <script>

    var outScale = 8;
    var spacePressed = false;

    var drawSegments = [];
    document.onkeydown = function(e) {
        e = e || window.event;
        if (e.keyCode == '32')
        {
            spacePressed = true;
        }
        else if (e.keyCode == '65')
        {
            drawSegments = []
        }
        else if (e.keyCode == '37')
        {
            shiftRight();
        }
        else if (e.keyCode == '39')
        {
            shiftLeft();
        }
    };
    document.onkeyup = function(e) {
        e = e || window.event;
        if (e.keyCode == '32')
        {
            spacePressed = false;
            shiftLeft();
            drawSegments.push(-1, -1);
        }
    };

    tracking.ColorTracker.registerColor('drawC', function(r, g, b) {
        var threshold = 40;
        if (g-b > threshold && g-r > threshold && g > 80)
            return true;
        return false;
    });


    var context = undefined;
    var context2 = undefined;
    var maxWidth = 40;
    var pointerVisible = false;
    function showBox(event) {
        if (context != undefined)
        {
            pointerVisible = true;
            context.clearRect(0, 0, canvas.width, canvas.height);
            context2.clearRect(0, 0, canvas.width, canvas.height);

            var i = 0;
            event.data.forEach(function(rect) {
                i++;
                if (rect.width < maxWidth && rect.height < maxWidth)
                {
                    context.strokeStyle = '#007f00';
                    context.lineWidth = 5;
                    var w2 = rect.width;
                    var h2 = rect.height;
                    context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    context.lineWidth = 15;
                    context.font = '11px Helvetica';
                    context.fillStyle = "#fff";
                    context.fillText('i: ' + i, rect.x + rect.width + 5, rect.y);
                    context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                    context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                    context.fillText('w: ' + rect.width + 'px', rect.x + rect.width + 5, rect.y + 33);
                    context.fillText('h: ' + rect.height + 'px', rect.x + rect.width + 5, rect.y + 44);
                }
            });
        }
    }

    function shiftLeft() {
            for (var j = 0; j < drawSegments[i].length; j += 2)
            {
                if (drawSegments[j] != -1 && drawSegments[j+1] != -1)
                    drawSegments[j] += 100;
            }
    }

    function shiftRight() {
            for (var j = 0; j < drawSegments[i].length; j += 2)
            {
                if (drawSegments[j] != -1 && drawSegments[j+1] != -1)
                    drawSegments[j] -= 100;
            }
    }

    window.onload = function() {
      var drawColour = 'drawC';

      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var canvas2 = document.getElementById('canvas2');
      context = canvas.getContext('2d');
      context2 = canvas2.getContext('2d');

      drawSegments = [];

      var tracker = new tracking.ColorTracker([drawColour]);
      tracker.setMinDimension(3);

      tracking.track('#video', tracker, { camera: true });

      tracker.on('track', function(event) {
        showBox(event);  
        if (! spacePressed)
            return;

        event.data.forEach(function(rect) {
            if (rect.width < maxWidth && rect.height < maxWidth)
            {
                if (rect.color === drawColour)
                {
                        draw(rect);
                }
            }
        });
      });

      function draw(rect) {
        drawSegments.push(rect.x, rect.y);
      }

      function erase(rect) {
        context.clearRect(rect.x, rect.y, rect.width, rect.height);
      }

    
      function addLineBit(x0, y0, x1, y1) {
          var dx = x1-x0;
          var dy = y1-y0;
          var mag = (Math.pow(dx,2) + Math.pow(dy, 2));
          if (mag < 1000)
          {
              var newPosX = x0+dx/4;
              var newPosY = y0+dy/4;
              context.lineTo(newPosX, newPosY);
              context2.lineTo(newPosX/outScale, newPosY/outScale);
          }
      }

      (function loop() {
          var points = drawSegments;
          var idx = 0;
          context.strokeStyle="#FF0000";
          context.beginPath();
          context2.strokeStyle="#000000";
          context2.beginPath();

          context.moveTo(points[idx], points[idx+1]);
          context2.moveTo(points[idx]/outScale, points[idx+1]/outScale);
          for (var idx = idx+2; idx < points.length; idx += 2)
          {
              if (points[idx] == -1 && points[idx+1] == -1)
              {
                  context.stroke();
                  context.beginPath();
                  context2.stroke();
                  context2.beginPath();
              }
              else
              {
                  addLineBit(points[idx-2], points[idx-1], points[idx], points[idx+1]);
              }
          }
          pointerVisible = false;
          context.stroke();
          context.beginPath();
          context2.stroke();
          context2.beginPath();


          requestAnimationFrame(loop);
      }());

    };
  </script>

</body>
</html>
